# Структура БД TutorBot (ingestion и задачи)

Кратко: таблицы, назначение и связи. База `tutorbot` (PostgreSQL).

---

## Схема связей (ingestion)

```
books (учебник/книга)
  │
  ├── pdf_sources (загруженный PDF как источник)
  │     │
  │     └── pdf_pages (страницы PDF + ocr_text)
  │             │
  │             └── problems.source_page_id → страница, с которой извлекли задачу
  │
  ├── section_theory (теория по параграфам §N)
  │
  └── problems (задачи/упражнения по книге)
          │
          └── problem_parts (подупражнения: 1), 2), а), б))
```

---

## Таблицы

### 1. `books`

**Назначение:** каталог учебников (книга как логическая сущность: предмет, класс, название).

| Поле | Тип | Назначение |
|------|-----|------------|
| id | PK | Идентификатор книги |
| subject | string | Предмет: geometry, math, physics, … |
| grade | string | Класс: "7", "8", "7-11" |
| title | string | Название учебника |
| authors | string | Авторы |
| publisher | string | Издательство |
| edition_year | int | Год издания |
| part | string | Часть (если многотомник) |
| is_gdz | bool | Решебник (true) или учебник (false) |

**Связи:** одна книга может иметь несколько `pdf_sources` (разные файлы/издания); от книги зависят `problems`, `section_theory`.

---

### 2. `pdf_sources`

**Назначение:** один загруженный PDF-файл как источник страниц и текста. Ссылается на книгу (`book_id`).

| Поле | Тип | Назначение |
|------|-----|------------|
| id | PK | Идентификатор источника |
| book_id | int | Книга, к которой привязан этот PDF |
| minio_key | string | Путь к файлу в хранилище (например pdfs/имя.pdf) |
| original_filename | string | Исходное имя файла |
| file_size_bytes | int | Размер файла |
| page_count | int | Число страниц (после обработки) |
| status | string | pending / ocr / done / failed |
| error_message | text | Сообщение об ошибке при сбое |

**Связи:**  
- `book_id` → книга;  
- у одного `pdf_source` много `pdf_pages`.

---

### 3. `pdf_pages`

**Назначение:** одна страница одного PDF. Здесь лежит нормализованный текст страницы (`ocr_text`), по которому дальше сегментируют задачи и теорию.

| Поле | Тип | Назначение |
|------|-----|------------|
| id | PK | Идентификатор страницы |
| pdf_source_id | int | Какой PDF |
| page_num | int | Номер страницы (0-based в коде) |
| image_minio_key | string | Опционально: картинка страницы в MinIO |
| ocr_text | text | Текст страницы после OCR и нормализации (LLM) |
| ocr_confidence | int | Уверенность OCR (0–100) |
| needs_review | bool | Нужна ли ручная проверка |
| reviewed_at | datetime | Когда проверили |

**Связи:**  
- `pdf_source_id` → `pdf_sources`;  
- `problems.source_page_id` → `pdf_pages.id` (страница, с которой извлекли задачу).

---

### 4. `problems`

**Назначение:** одна извлечённая задача/упражнение/вопрос из учебника. Должны попадать сюда только реальные формулировки задач, а не оглавление, тираж, лицензия и т.п. — за это отвечает уже LLM-распределение, а не старый скрипт по регуляркам.

| Поле | Тип | Назначение |
|------|-----|------------|
| id | PK | Идентификатор задачи |
| book_id | int | Книга |
| source_page_id | int | Страница PDF, откуда извлекли (pdf_pages.id) |
| number | string | Номер задачи: "315", "22.1" |
| section | string | Параграф/раздел: "§12", "§22" |
| problem_text | text | Условие задачи (основное поле) |
| problem_text_clean | text | Постобработанный текст (если есть) |
| solution_text | text | Решение |
| answer_text | text | Краткий ответ |
| page_ref | string | Ссылка на страницу для пользователя, напр. "стр. 45" |
| bbox | json | Координаты на странице (если есть) |
| problem_type | string | question / exercise / unknown |
| has_parts | bool | Есть ли подпункты (тогда в problem_parts) |
| confidence | int | Уверенность извлечения (0–100) |
| needs_review | bool | Нужна ли ручная проверка |

**Связи:**  
- `book_id` → `books`;  
- `source_page_id` → `pdf_pages`;  
- при `has_parts = true` подпункты в `problem_parts` (заполняются при LLM-распределении из поля `parts` в ответе модели).

**Почему в БД был «шлак» при старом процессинге:** скрипт резал текст по регуляркам (№, «Задача», «Упражнение», «Решение.» и т.д.) и любое совпадение считал началом «задачи». В итог в `problem_text` попадали оглавление, выходные данные, лицензия, номера заказов — всё, что похоже на номер или заголовок. LLM-распределение как раз и нужно, чтобы в `problems` писались только блоки с типом `problem` и осмысленным условием.

---

### 5. `section_theory`

**Назначение:** теоретический текст по параграфу (§ N) — определения, теоремы, доказательства. Используется для ответов на контрольные вопросы и обоснования решений через LLM.

| Поле | Тип | Назначение |
|------|-----|------------|
| id | PK | Идентификатор записи |
| book_id | int | Книга |
| section | string | Номер параграфа: "§7", "§12" |
| theory_text | text | Текст теории параграфа |
| page_ref | string | Ссылка на страницы, напр. "стр. 45–48" |

**Связи:**  
- `book_id` → `books`.  
В одной книге один параграф = одна запись (или перезапись при новом импорте).

---

### 6. `problem_parts`

**Назначение:** подпункты одной задачи (например «1) … 2) …» или «а) … б) …»). Заполняются при LLM-распределении, если модель вернула для задачи массив `parts`.

| Поле | Тип | Назначение |
|------|-----|------------|
| id | PK | Идентификатор подпункта |
| problem_id | FK | Задача (problems.id), CASCADE при удалении |
| part_number | string | "1", "2", "а", "б" |
| part_text | text | Текст подпункта |
| answer_text | text | Ответ на подпункт |
| solution_text | text | Решение подпункта |

**Связи:**  
- `problem_id` → `problems`.

---

## Дополнительные таблицы (не ingestion)

- **users** — пользователи (Telegram и т.п.).  
- **plans** / **subscriptions** — тарифы и подписки.  
- **queries** — запрос пользователя (вопрос по задаче); `user_id` → users.  
- **responses** — ответ LLM на запрос; `query_id` → queries.

---

## Итог по связям

| От кого | Связь | К кому |
|---------|--------|--------|
| pdf_sources | N → 1 | books |
| pdf_pages | N → 1 | pdf_sources |
| problems | N → 1 | books |
| problems | N → 1 | pdf_pages (source_page_id) |
| section_theory | N → 1 | books |
| problem_parts | N → 1 | problems |

При новом LLM-распределении для источника мы полностью перезаписываем данные по этому источнику: удаляем его `pdf_pages` и связанные `problems`, удаляем `section_theory` по этой книге, затем заново пишем страницы, задачи и теорию из ответов LLM — чтобы в `problems` и `section_theory` не оставалось «шлака» от старого скрипта.
