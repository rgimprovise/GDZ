# Качество нормализованного текста и влияние верстки

Кратко: от чего страдает качество текста после OCR и нормализации, как колонтитулы попадают в данные и что с этим делаем.

---

## 1. Откуда берётся нормализованный текст

1. **OCR** (Tesseract) по каждой странице PDF → сырой текст страницы.
2. **ocr_cleaner** — базовая очистка (латиница/кириллица, переносы и т.п.).
3. **LLM-нормализация** (OpenAI) — исправление ошибок OCR и формул, запись в `data/ocr_normalized/{book_id}/{pdf_source_id}.md` по блокам `## Страница N`.
4. **Распределение по БД** — чтение этого файла, разбиение по параграфам/блокам, LLM-разметка, запись в `section_theory` и `problems`.

---

## 2. Влияние верстки учебника

Учебники часто имеют **колонтитулы** (header/footer) на каждой странице:

- заголовок типа «N класс», «Геометрия», «82 8 класс»;
- номер страницы в углу;
- подписи к рисункам, которые OCR выносит в отдельные строки вместе с номером страницы или классом.

Всё это **попадает в OCR** вместе с основным текстом. В результате:

- в середине параграфа оказываются строки вроде «82 8 класс», «Рис. 114 Рис. 115 82 8 класс»;
- текст выглядит раздробленным, не цельным параграфом;
- при разметке (теория/задачи) модель и скрипты путаются из‑за лишних строк.

---

## 3. Что делаем

### 3.1. LLM-нормализация

В системном промпте (**`llm_ocr_correct.py`**) явно указано:

- удалять колонтитулы и служебные строки верстки (повторяющийся заголовок с классом/предметом, отдельно стоящий номер страницы, короткие строки из цифр/пробелов);
- оставлять только основной текст параграфа, задач и подписей к рисункам в контексте;
- подпись «Рис. N» внутри предложения сохранять; строки, где к подписям примешаны номер страницы или класс, — очищать от артефактов.

При повторном запуске «LLM нормализация» уже сохранённый файл перезаписывается с учётом этих правил.

### 3.2. Очистка при чтении для распределения по БД

Перед подачей текста в **«Распределение в БД»** к каждой странице из нормализованного файла применяется **`strip_page_headers_footers`** (**`ocr_files.py`**):

- удаляются строки, совпадающие с типичными колонтитулами: «N класс», «82 8 класс», отдельно стоящий номер страницы, короткие строки из одних цифр/пробелов;
- основной текст параграфа и задач не меняется.

Таким образом, даже если в файле после LLM-нормализации остались колонтитулы, при распределении по БД в LLM и в скрипты попадает уже очищенный текст.

### 3.3. Разбиение по параграфам

Текст в LLM для разметки подаётся **целиком по параграфам** (§ N): один параграф — один запрос. Границы параграфов определяются по заголовкам «§ N», «Параграф N» или (при их отсутствии) по нумерованным заголовкам. Так модель получает контекст целого параграфа, а не только обрезанные по страницам куски.

---

## 4. Итог

- **Колонтитулы:** удаляются на этапе LLM-нормализации (промпт) и дополнительно при чтении для распределения по БД (`strip_page_headers_footers`).
- **«Маленькие куски»:** за счёт режима по параграфам в распределении модель видит полный текст параграфа; артефакты колонтитулов при очистке не разбивают параграф на лишние фрагменты.
- **Верстка:** явно учтена в промпте и в скрипте очистки; при появлении новых типов артефактов их можно добавить в паттерны в `ocr_files.py` (комментарий «Паттерны колонтитулов»).
