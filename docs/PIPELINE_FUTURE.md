# Целевой пайплайн: два прохода OCR, нормализация ИИ, изображения из учебников

Документ фиксирует схему, которую планируется реализовать далее.

**Важно:** сырой результат OCR и промежуточные варианты хранятся в **файлах** (не в БД); в БД попадает только **проверенный, нормализованный** текст. Подробно: **`docs/OCR_FILES_AND_NORMALIZATION.md`** (формат .md по страницам/параграфам, сравнение OCR, нормализация по файлам без повторного OCR).

---

## 1. Два прохода OCR и сохранение обоих результатов

| Шаг | Действие | Сохранение |
|-----|----------|------------|
| 1 | **Первый проход:** рендер страницы → Tesseract OCR → текст итерации 1 | **Файл(ы)** (например `data/ocr_raw/{book_id}/{source_id}_tesseract.md` по страницам) — для сравнения и нормализации без повторного OCR. |
| 2 | **Второй проход:** тот же рендер → более точная модель (EasyOCR / PaddleOCR / API) → текст итерации 2 | **Файл(ы)** (например `data/ocr_raw/{book_id}/{source_id}_easyocr.md`) |
| 3 | Оба результата в файлах; сравнение и нормализация работают по файлам; в БД — только итог после нормализации. |

См. `OCR_FILES_AND_NORMALIZATION.md`: структура по страницам/параграфам, формат .md, каталоги `ocr_raw` и `ocr_normalized`.

---

## 2. Анализ различий и нормализация с помощью ИИ

| Шаг | Действие | Уточнения |
|-----|----------|------------|
| 1 | ИИ получает **оба текста** (v1 и v2) постранично или по главам. | Чтобы не переполнять контекстное окно: разбивать на **равные части** (например по N страниц или по N символов), обрабатывать чанками. |
| 2 | ИИ читает пару текстов (v1 и v2 для одного чанка), определяет **артефакты и ошибки**, предлагает **нормализованный текст**. | Критерии: опечатки OCR, латиница вместо кириллицы, разрывы слов/строк, дубли, пропуски. |
| 3 | Нормализованный результат записывается в **файл(ы)** (например `data/ocr_normalized/...`) и затем **импортируется в БД** в `pdf_pages.ocr_text`; в БД только этот проверенный текст для сегментации. |

Важно: чанки должны быть **равными** (по объёму или по числу страниц); ИИ читает **файлы** по частям, не вытаскивая текст из БД. См. `OCR_FILES_AND_NORMALIZATION.md`.

---

## 3. Изображения из учебников: извлечение и привязка

Сейчас изображения (рисунки, схемы) из PDF **не извлекаются** и **не сохраняются**; в текст OCR попадают только подписи как строки. Целевое поведение:

### 3.1 Обнаружение и извлечение изображений

| Шаг | Действие |
|-----|----------|
| 1 | По каждой странице PDF (или по рендеру страницы) определить **области с рисунками/схемами** (не текст): либо по метаданным PDF (XObject/Image), либо по детекции областей без текста / с подписями «рис.» рядом. |
| 2 | Вырезать каждую такую область в отдельный **файл-изображение** (например PNG). |
| 3 | Сохранить файл в хранилище (MinIO/S3), записать ключ и **привязку к странице** (pdf_page_id, page_num, порядковый номер рисунка на странице, при необходимости bbox). |

Требуется: таблица «рисунки/схемы» (например `book_figures`): id, book_id, pdf_page_id, figure_index_on_page, minio_key, caption_text, page_ref, bbox (опционально).

### 3.2 Подписи к рисункам в тексте

Подписи в учебниках обычно имеют вид:

- **рис. N** или **рис. N "название"** или **Рис. N. Название**
- **схема. N** или **схема N "название"**
- **табл. N** и т.п.

Порядковая нумерация (1, 2, 3…) может быть в пределах параграфа, страницы или главы.

| Шаг | Действие |
|-----|----------|
| 1 | В нормализованном тексте (ocr_text) искать паттерны подписей: например `рис\.\s*(\d+)`, `схема\.?\s*(\d+)`, `табл\.\s*(\d+)`, с опциональным названием в кавычках или после точки. |
| 2 | Для каждого совпадения: номер рисунка (N), текст подписи, страница (page_num), контекст (абзац или блок теории/задачи, в котором встречается подпись). |
| 3 | Сопоставить с сохранёнными изображениями: по (page_id, figure_index) или по (page_id, number_in_caption) — и записать связь «подпись ↔ файл-изображение». |

### 3.3 Привязка рисунка к теории / вопросу / задаче

| Шаг | Действие |
|-----|----------|
| 1 | Для каждой сущности (теория параграфа, вопрос, задача) — текст блока уже есть в БД (section_theory.theory_text, problems.problem_text и т.д.). |
| 2 | Если в этом тексте **упоминается подпись** (например «рис. 1», «схема 2»), то считать, что эта сущность **ссылается на соответствующий рисунок**. |
| 3 | Сохранить связь: «теория §7 → рисунки рис.1, рис.2» или «задача 24 → рис.3» (например в таблице figure_references: entity_type, entity_id, figure_id). |
| 4 | В интерфейсе/ответах: показывать местонахождение рисунка (страница, подпись) и при необходимости отдавать само изображение по minio_key. |

Итог: изображения из учебников сохраняются отдельно, привязываются к странице и к подписи; по упоминанию подписи в тексте теории/вопроса/задачи мы знаем, какой рисунок к чему относится.

---

## 4. Порядок этапов в целевом пайплайне

1. **OCR, итерация 1:** Tesseract → сохранение текста v1.  
2. **OCR, итерация 2:** более точная модель → сохранение текста v2.  
3. **Нормализация ИИ:** сравнение v1 и v2 по равным чанкам, выдача нормализованного текста → сохранение в итоговое поле.  
4. **Изображения:** извлечение областей рисунков со страниц → сохранение в файлы и в таблицу рисунков с привязкой к странице.  
5. **Подписи в тексте:** разбор нормализованного текста на паттерны «рис. N», «схема. N» и т.д. → связь подпись ↔ сохранённое изображение.  
6. **Сегментация:** теория (§ N … Задачи/Упражнения), задачи (условие + «Решение.»/«Ответ.») по нормализованному тексту — как сейчас, но по полю с нормализованным текстом.  
7. **Привязка рисунков к сущностям:** по упоминаниям подписей в theory_text / problem_text связать теорию и задачи с записями в таблице рисунков.  

Дальнейшие шаги (assign_sections, link_answers, теория для LLM и т.д.) работают уже с нормализованным текстом и при необходимости с учётом привязанных рисунков.

---

## 5. Ссылки на текущий код

- Определение теории: `apps/worker/ingestion.py` → `extract_and_save_section_theory()`, `RE_SECTION_HEADER`, `RE_TASK_BLOCK_START`.
- Определение задач и решений: `apps/worker/ingestion.py` → `segment_problems()`, список `patterns`, `RE_SOLUTION_START`.
- Сущности и таблицы: `docs/ENTITIES_AND_DETECTION.md`.
- Текущий пайплайн (один OCR, нормализация ocr_cleaner, сегментация): `docs/PIPELINE_PDF.md`.
