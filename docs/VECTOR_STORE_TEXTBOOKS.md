# Как размещать учебники в Vector Store для эффективных ответов LLM

Краткие правила, чтобы поиск по хранилищу возвращал релевантные фрагменты и модель давала точные ответы по задачам и теории.

---

## 1. Чем резать на фрагменты (chunking)

- **Один фрагмент = один смысловой объект.** Не резать посередине абзаца или определения.
- **Задачи:** один фрагмент = одна задача: условие + при необходимости ответ/решение. Номер и параграф должны быть в начале фрагмента (см. ниже).
- **Теория:** один фрагмент = один параграф (§ N) или один подпункт параграфа. Не смешивать в одном фрагменте конец §7 и начало §8.

Итог: резать по **параграфам** (теория) и по **задачам** (условие + ответ), а не по фиксированному числу символов без учёта структуры.

---

## 2. Что писать в начале каждого фрагмента (заголовок)

В самом тексте фрагмента в первой строке указывать:

- **Теория:** параграф и, при желании, книгу.  
  Пример: `[§12] Сфера и шар. Касательная плоскость...` или `Книга: Геометрия 11. §12. Сфера и шар...`
- **Задача:** параграф, номер задачи, при необходимости тип.  
  Пример: `[§12, Задача 315] Докажите, что...` или `§12, №315. Докажите, что...`

Так модель и пользователь сразу видят источник (параграф, номер задачи); поиск по смыслу лучше «привязывается» к этим меткам.

---

## 3. Разделять теорию и задачи

- Либо **отдельные файлы/секции:** например, все параграфы теории в одних файлах, все задачи — в других (или один файл с явными заголовками `## ТЕОРИЯ §N` и `## ЗАДАЧИ §N`).
- Либо **один файл с чёткими подзаголовками:** каждая запись начинается с `[ТЕОРИЯ §N]` или `[ЗАДАЧА §N №...]`.

Так модель понимает, что перед ней — теория или условие задачи, и не путает одно с другим.

---

## 4. Формат файлов для загрузки в Vector Store

- Предпочтительно **текст:** `.txt` или `.md` с заголовками, как выше. У вас уже есть нормализованный текст (после OCR и распределения по БД) — его проще резать по параграфам/задачам и выгружать, чем PDF.
- **PDF** режется по страницам; границы параграфов и задач при этом теряются. Использовать PDF только если нет структурированного текста.

**Пример структуры одного файла (одна книга):**

```text
[ТЕОРИЯ §1] Основные свойства простейших геометрических фигур. Точка и прямая...
(полный текст параграфа)

[ЗАДАЧА §1 №1] Три точки A, B, C лежат на одной прямой...
(условие и при необходимости ответ)

[ЗАДАЧА §1 №2] Может ли прямая...
(условие и ответ)

[ТЕОРИЯ §2] Измерение отрезков...
```

Либо **отдельные файлы:** `book1_theory_§1.txt`, `book1_theory_§2.txt`, `book1_problems_§1.txt` и т.д. — тогда один файл = один или несколько однотипных фрагментов с заголовками выше.

---

## 5. Несколько книг

- **Вариант A:** один Vector Store на все книги. В каждый фрагмент в начале добавлять книгу: `[Геометрия 11, §12]` или `[Алгебра 8, §5, №234]`. В системном промпте ассистента указать: «Используй только материал из запроса пользователя о книге/классе» (или фильтровать по метке книги в запросе).
- **Вариант B:** отдельный Vector Store на каждую книгу (или на предмет/класс). Тогда поиск и ответ привязываются к выбранной книге без лишних меток в тексте.

---

## 6. Объём фрагмента

- **Теория:** параграф целиком (или крупный подпункт) — обычно от нескольких сотен до 2–4 тыс. символов. Слишком длинный параграф можно резать по подзаголовкам («1. …», «2. …»), сохраняя в начале фрагмента метку §N.
- **Задача:** условие + ответ (и при необходимости краткое решение) в одном фрагменте. Обычно 200–1500 символов.

OpenAI при загрузке файла сам разбивает длинный текст на куски; если вы заранее режете по параграфам/задачам и кладёте в один файл несколько блоков с заголовками, границы между вашими блоками лучше не нарушать (например, разделять блоки пустой строкой и явной меткой `[ТЕОРИЯ §N]` / `[ЗАДАЧА §N №...]`).

---

## 7. Экспорт из вашей БД в формат для Vector Store

У вас уже есть структура: `section_theory` (параграф → текст теории), `problems` (задача, номер, параграф, условие, ответ). Можно:

1. Выгрузить из БД по книге все `section_theory` и все `problems`.
2. Для каждой записи сформировать один блок с заголовком в начале (как в примерах выше).
3. Собрать в один или несколько `.txt`/`.md` файлов (например, один файл = одна книга) и загрузить в Vector Store.

Так учебники в Vector Store будут соответствовать тому, что уже размещено в БД, и LLM сможет эффективно находить и теорию, и нужную задачу по запросу пользователя.
